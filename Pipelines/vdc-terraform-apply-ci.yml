trigger:
- master

jobs:
- job: 'Terraform'
  displayName: 'VDC CI'
  timeoutInMinutes: 120

# Set variables once
  variables:
    iaasResourceGroup: '$(TF_VAR_resource_prefix)-$(TF_VAR_resource_environment)-iaasapp-$(TF_VAR_resource_suffix)'
    paasResourceGroup: '$(TF_VAR_resource_prefix)-$(TF_VAR_resource_environment)-paasapp-$(TF_VAR_resource_suffix)'
    vdcResourceGroup: '$(TF_VAR_resource_prefix)-$(TF_VAR_resource_environment)-$(TF_VAR_resource_suffix)'
    scriptDirectory: 'Scripts'

  pool:
    name: $(pool)
    demands:
    - Agent.OS -equals Linux

  workspace:
    clean: all

  steps:
    - task: DownloadSecureFile@1
      displayName: 'Download SSL certificate'
      inputs:
        secureFile: '$(TF_VAR_vanity_certificate_path)'

    - task: DownloadSecureFile@1
      displayName: 'Download VPN root certificate'
      inputs:
        secureFile: '$(TF_VAR_vpn_root_cert_file)'

    - task: PowerShell@2
      name: TerraformTest
      displayName: 'Get preferred Terraform version number'
      inputs:
        filePath: '$(scriptDirectory)/get_tf_version.ps1'
        arguments: '-Version Preferred'
        pwsh: true

    - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
      displayName: 'Use preferred Terraform version'
      inputs:
        terraformVersion: '$(TerraformTest.Version)'

    - task: AzurePowerShell@4
      displayName: 'Terraform init and apply'
      inputs:
        azureSubscription: '$(subscription)'
        ScriptType: 'FilePath'
        ScriptPath: '$(scriptDirectory)/tf_deploy.ps1'
        ScriptArguments: '-init -clear -apply -force -workspace $(workspace) -trace $(trace) -parallelism $(parallelism)'
    #   ScriptArguments: '-init -force -workspace $(workspace) -trace $(trace) -parallelism $(parallelism)'
        FailOnStandardError: true
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true

    - task: AzureResourceGroupDeployment@2
      displayName: 'Deallocate VM''s in App resource group'
      inputs:
        azureSubscription: '$(subscription)'
        action: StopWithDeallocate
        resourceGroupName: '$(iaasResourceGroup)'

    - task: AzureResourceGroupDeployment@2
      displayName: 'Stop VM''s in VDC resource group'
      inputs:
        azureSubscription: '$(subscription)'
        action: Stop
        resourceGroupName: '$(vdcResourceGroup)'

    - task: AzurePowerShell@4
      displayName: 'Terraform init and apply (re-entrancy test)'
      name: Terraform
      inputs:
        azureSubscription: '$(subscription)'
        ScriptType: 'FilePath'
        ScriptPath: '$(scriptDirectory)/tf_deploy.ps1'
        ScriptArguments: '-init -apply -force -workspace $(workspace) -trace $(trace) -parallelism $(parallelism)'
        FailOnStandardError: true
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true

    - task: AzurePowerShell@4
      displayName: 'Terraform destroy'
      inputs:
        azureSubscription: '$(subscription)'
        ScriptPath: '$(scriptDirectory)/tf_deploy.ps1'
        ScriptArguments: '-init -destroy -force -workspace $(workspace) -trace $(trace) -parallelism $(parallelism)'
        FailOnStandardError: true
        azurePowerShellVersion: LatestVersion
        pwsh: true
      condition: succeededOrFailed()

    - task: AzureResourceGroupDeployment@2
      displayName: 'Tear down IaaS App resource group'
      inputs:
        azureSubscription: '$(subscription)'
        action: DeleteRG
        resourceGroupName: '$(iaasResourceGroup)'
      continueOnError: true
      condition: always()

    - task: AzureResourceGroupDeployment@2
      displayName: 'Tear down PaaS App resource group'
      inputs:
        azureSubscription: '$(subscription)'
        action: DeleteRG
        resourceGroupName: '$(paasResourceGroup)'
      continueOnError: true
      condition: always()

    - task: AzureResourceGroupDeployment@2
      displayName: 'Tear down VDC resource group'
      inputs:
        azureSubscription: '$(subscription)'
        action: DeleteRG
        resourceGroupName: '$(vdcResourceGroup)'
      continueOnError: true
      condition: always()

    - task: AzurePowerShell@4
      displayName: 'Clear Terraform workspace'
      inputs:
        azureSubscription: '$(subscription)'
        ScriptPath: '$(scriptDirectory)/tf_clear_state.ps1'
        ScriptArguments: '-workspace $(workspace) -Destroy -Force'
        FailOnStandardError: true
        azurePowerShellVersion: LatestVersion
        pwsh: true
      condition: succeededOrFailed()

    - task: PowerShell@2
      displayName: 'Save used Terraform version number with tfenv'
      inputs:
        targetType: filePath
        filePath: '$(scriptDirectory)/get_tf_version.ps1'
        arguments: ' -Version installed | Out-File $(Build.SourcesDirectory)/Terraform/.terraform-version'
        pwsh: true

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Initialized Terraform workspace (inc. providers)'
      inputs:
        artifact: drop
